<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VOID - Etapa XXXVII</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        #setup-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10000; background: #000; color: #00FFFF; padding: 30px;
            border: 2px solid #00FFFF; border-radius: 15px; text-align: center;
            font-family: 'Courier New', monospace; box-shadow: 0 0 30px #00FFFF;
        }
        button {
            background: #00FFFF; border: none; padding: 15px 30px;
            font-weight: bold; cursor: pointer; border-radius: 5px; color: #000;
        }
    </style>
</head>
<body>

    <div id="setup-panel">
        <h2>VOID: INTERFACE ATIVA</h2>
        <button id="start-btn">INICIAR SISTEMAS</button>
    </div>

    <a-scene background="color: #000000" cursor="rayOrigin: mouse">
        <a-entity id="void-core" class="clickable"
                  geometry="primitive: sphere; radius: 0.15" 
                  material="color: #00FFFF; shader: flat" 
                  position="0 1.5 -2"
                  animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 2000; loop: true">
        </a-entity>

        <a-text id="neon-letter" value="" align="center" color="#FFFFFF" 
                position="0 2.0 -2" scale="2 2 2"
                font="https://cdn.aframe.io/fonts/Mozor-Bold.fnt"></a-text>

        <a-camera position="0 1.6 0">
            <a-cursor color="#00FFFF" raycaster="objects: .clickable"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        const API_KEY = localStorage.getItem('gemini_key') || prompt("API Key:");
        if (API_KEY) localStorage.setItem('gemini_key', API_KEY.trim());

        const core = document.querySelector('#void-core');
        const neonLetter = document.querySelector('#neon-letter');
        const setupPanel = document.querySelector('#setup-panel');
        const startBtn = document.querySelector('#start-btn');

        let alphabetQueue = [];
        let currentIdx = 0;

        // --- VOZ NATURAL ---
        const speak = (text) => {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            // Tenta encontrar uma voz premium em português
            const bestVoice = voices.find(v => v.lang.includes('pt') && v.name.includes('Google')) || 
                              voices.find(v => v.lang.includes('pt')) || 
                              voices[0];
            u.voice = bestVoice;
            u.lang = 'pt-BR';
            u.rate = 0.9; // Um pouco mais lento para ser didático
            window.speechSynthesis.speak(u);
        };

        startBtn.onclick = async () => {
            speak("Sistemas prontos. Aguardando comando.");
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                setupPanel.style.display = 'none';
            } catch (e) { alert("Permita o microfone."); }
        };

        // --- RECONHECIMENTO ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR';

        core.addEventListener('click', () => {
            if (alphabetQueue.length > 0) {
                proximaLetra();
            } else {
                recognition.start();
                core.setAttribute('material', 'color', '#FF00FF');
            }
        });

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase();
            core.setAttribute('material', 'color', '#FFFF00');
            
            if (transcript.includes("alfabeto") || transcript.includes("ensine")) {
                await iniciarAula();
            } else {
                responderSimples(transcript);
            }
        };

        async function iniciarAula() {
            try {
                speak("Vou carregar o alfabeto para você. Um momento.");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
                
                // Prompt reforçado para evitar textos extras
                const promptAula = 'Responda APENAS com um array JSON puro, sem markdown, contendo as letras A, B, C, D e E (para teste rápido) neste formato: [{"l": "Letra", "t": "Texto didático"}].';

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptAula }] }] })
                });
                
                const data = await res.json();
                let rawText = data.candidates[0].content.parts[0].text;
                
                // Limpeza agressiva de Markdown (```json)
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                alphabetQueue = JSON.parse(rawText);
                currentIdx = 0;
                proximaLetra();
            } catch (e) {
                console.error(e);
                speak("Houve um problema ao organizar a aula. Tente novamente.");
                core.setAttribute('material', 'color', '#FF0000');
            }
        }

        function proximaLetra() {
            if (currentIdx < alphabetQueue.length) {
                const item = alphabetQueue[currentIdx];
                neonLetter.setAttribute('value', item.l);
                core.setAttribute('material', 'color', '#00FF00'); // Verde
                speak(item.t);
                currentIdx++;
            } else {
                speak("Aula concluída. Clique para um novo comando.");
                alphabetQueue = [];
                neonLetter.setAttribute('value', '');
                core.setAttribute('material', 'color', '#00FFFF');
            }
        }

        async function responderSimples(t) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "Responda em uma frase: " + t }] }] })
            });
            const data = await res.json();
            const resp = data.candidates[0].content.parts[0].text;
            core.setAttribute('material', 'color', '#00FFFF');
            speak(resp);
        }

        recognition.onend = () => {
            if (core.getAttribute('material').color === '#FF00FF') core.setAttribute('material', 'color', '#00FFFF');
        };
    </script>
</body>
</html>
