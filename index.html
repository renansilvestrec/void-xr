<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VOID - Etapa XXX</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
</head>
<body>
    <button id="audio-unlock" style="position:fixed; z-index:9999; padding:15px; background:#00FFFF; border:none; font-weight:bold;">1. LIBERAR VOZ</button>

    <a-scene background="color: #000000" cursor="rayOrigin: mouse" raycaster="objects: .clickable">
        <a-entity id="void-core" 
                  class="clickable"
                  geometry="primitive: sphere; radius: 0.2" 
                  material="color: #00FFFF; shader: flat" 
                  position="0 1.5 -2"
                  event-set__mouseenter="_event: mouseenter; material.color: #FFFFFF"
                  event-set__mouseleave="_event: mouseleave; material.color: #00FFFF">
        </a-entity>

        <a-camera position="0 1.6 0"><a-cursor color="#00FFFF" raycaster="objects: .clickable"></a-cursor></a-camera>
        <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-scene>

    <script>
        let API_KEY = localStorage.getItem('gemini_key');
        if (!API_KEY) {
            API_KEY = prompt("API Key:");
            if (API_KEY) localStorage.setItem('gemini_key', API_KEY.trim());
        }

        const core = document.querySelector('#void-core');
        const unlockBtn = document.querySelector('#audio-unlock');

        // FUNÇÃO DE FALA PROTEGIDA
        const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel(); // Para falas anteriores
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.onend = () => { console.log("Terminou de falar"); };
            window.speechSynthesis.speak(utterance);
        };

        // Solicita microfone e voz antes do VR
        unlockBtn.onclick = async () => {
            try {
                // Tenta ativar síntese de voz com frase de teste
                speak("Sistema de voz iniciado");
                
                // Pede microfone explicitamente
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    unlockBtn.style.background = "#00FF00";
                    unlockBtn.innerText = "SISTEMA PRONTO - ENTRE NO VR";
                }
            } catch (e) {
                console.error(e);
                unlockBtn.innerText = "ERRO MICROFONE";
            }
        };

        // RECONHECIMENTO DE VOZ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                core.setAttribute('material', 'color', '#FFFF00'); // Amarelo
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Responda curto: ${transcript}. Cor HEX no fim.` }] }] })
                    });
                    const data = await response.json();
                    if (data.candidates) {
                        const aiText = data.candidates[0].content.parts[0].text;
                        const hex = aiText.match(/#[0-9A-F]{6}/i);
                        core.setAttribute('material', 'color', hex ? hex[0] : '#00FFFF');
                        speak(aiText.replace(/#[0-9A-F]{6}/gi, ''));
                    }
                } catch (err) {
                    core.setAttribute('material', 'color', '#FF0000');
                }
            };

            recognition.onend = () => {
                if (core.getAttribute('material').color === '#FF00FF') {
                    core.setAttribute('material', 'color', '#00FFFF');
                }
            };
        }

        // EVENTO DE CLIQUE (Universal)
        core.addEventListener('click', () => {
            if (recognition) {
                try {
                    recognition.start();
                    core.setAttribute('material', 'color', '#FF00FF'); // Magenta
                } catch (e) {
                    recognition.stop();
                    console.log("Reiniciando reconhecimento...");
                }
            } else {
                alert("Seu navegador não suporta reconhecimento de voz.");
            }
        });
    </script>
</body>
</html>
