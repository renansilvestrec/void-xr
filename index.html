<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VOID - Etapa XVIII</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>
<body>
    <a-scene background="color: #000000">
        <a-entity id="void-core" geometry="primitive: sphere; radius: 0.15" material="color: #00FFFF; shader: flat" position="0 1.5 -2" animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: true"></a-entity>
        <a-camera position="0 1.6 0"><a-cursor color="#00FFFF"></a-cursor></a-camera>
    </a-scene>

    <script>
        let API_KEY = localStorage.getItem('gemini_key');
        if (!API_KEY || API_KEY === "null") {
            API_KEY = prompt("Cole sua API Key aqui:");
            if (API_KEY) localStorage.setItem('gemini_key', API_KEY.trim());
        }

        const core = document.querySelector('#void-core');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR';

        document.body.onmousedown = () => {
            try {
                recognition.start();
                core.setAttribute('material', 'color', '#FF00FF'); 
            } catch (e) { console.log("Já ouvindo..."); }
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            core.setAttribute('material', 'color', '#FFFF00'); 

            try {
                // A URL deve usar o nome exato que aparece no seletor do AI Studio
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "Responda em uma frase curta e termine com uma cor HEX: " + transcript }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    core.setAttribute('material', 'color', '#FF0000');
                    alert("Erro: " + (data.error ? data.error.message : "Desconhecido"));
                    // Se for erro de modelo (404), tentaremos o fallback automático
                    return;
                }

                const aiText = data.candidates[0].content.parts[0].text;
                const hexMatch = aiText.match(/#[0-9A-F]{6}/i);
                const hexColor = hexMatch ? hexMatch[0] : '#00FF00';

                core.setAttribute('material', 'color', hexColor);
                window.speechSynthesis.cancel();
                const speech = new SpeechSynthesisUtterance(aiText.replace(hexColor, '').trim());
                speech.lang = 'pt-BR';
                window.speechSynthesis.speak(speech);

            } catch (err) {
                core.setAttribute('material', 'color', '#FF0000');
                alert("Falha de rede: " + err.message);
            }
        };
    </script>
</body>
</html>
