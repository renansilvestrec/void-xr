<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOID - Etapa XLV (Reconstrução Premium)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        :root { --neon: #00FFFF; }
        body { background: #000; margin: 0; overflow: hidden; }
        #interface {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, #001a1a 0%, #000 70%);
            transition: opacity 1s ease;
        }
        .void-btn {
            background: none; border: 1px solid var(--neon); padding: 20px 40px;
            color: var(--neon); font-family: 'Courier New', monospace;
            font-size: 1.2rem; letter-spacing: 10px; cursor: pointer;
            box-shadow: 0 0 15px var(--neon); transition: 0.3s;
        }
        .void-btn:active { transform: scale(0.95); box-shadow: 0 0 30px var(--neon); }
        #status-bar { 
            position: fixed; bottom: 20px; width: 100%; text-align: center;
            color: var(--neon); font-family: monospace; font-size: 0.7rem;
            letter-spacing: 2px; opacity: 0.5; z-index: 50;
        }
    </style>
</head>
<body>

    <div id="interface">
        <h1 style="color: var(--neon); font-family: monospace; letter-spacing: 15px; margin-bottom: 50px;">VOID</h1>
        <button class="void-btn" id="init-link">CONECTAR</button>
    </div>

    <div id="status-bar">SISTEMA NEURAL OFFLINE</div>

    <a-scene background="color: #000" renderer="antialias: true; colorManagement: true;">
        <a-light type="ambient" color="#00FFFF" intensity="0.2"></a-light>
        <a-light type="point" id="core-light" position="0 1.5 -2" color="#00FFFF" intensity="0.8"></a-light>

        <a-entity id="void-core" class="clickable" position="0 1.5 -2">
            <a-sphere radius="0.1" material="shader: flat; color: #00FFFF;">
                <a-animation attribute="scale" to="1.2 1.2 1.2" direction="alternate" dur="2000" repeat="indefinite"></a-animation>
            </a-sphere>
            <a-sphere radius="0.15" material="shader: flat; color: #00FFFF; transparent: true; opacity: 0.2"
                      animation="property: scale; to: 1.5 1.5 1.5; dir: alternate; dur: 1000; loop: true"></a-sphere>
        </a-entity>

        <a-entity id="manifestation-anchor" position="0 1.5 -2">
            <a-text id="main-text" value="" align="center" position="0 0.8 0" scale="3 3 3"
                    font="https://cdn.aframe.io/fonts/Mozor-Bold.fnt" 
                    material="shader: flat; emissive: #FFFFFF; emissiveIntensity: 2"></a-text>
            
            <a-entity id="geometry-placeholder" position="0 0 0" scale="0 0 0"
                      animation__show="property: scale; to: 1 1 1; dur: 800; easing: easeOutElastic"
                      animation__hide="property: scale; to: 0 0 0; dur: 500; easing: easeInBack">
            </a-entity>
        </a-entity>

        <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: false">
            <a-cursor color="#00FFFF" raycaster="objects: .clickable"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        const API_KEY = localStorage.getItem('gemini_key') || prompt("Sua Gemini Key:");
        if(API_KEY) localStorage.setItem('gemini_key', API_KEY.trim());

        const core = document.querySelector('#void-core');
        const status = document.querySelector('#status-bar');
        const textEl = document.querySelector('#main-text');
        const shapeEl = document.querySelector('#geometry-placeholder');

        // Configuração de Voz Robusta
        const speak = (txt) => {
            return new Promise(resolve => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'pt-BR';
                u.rate = 1.0;
                u.onend = resolve;
                window.speechSynthesis.speak(u);
            });
        };

        // Reconhecimento de Voz
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new Speech();
        recognition.lang = 'pt-BR';

        document.querySelector('#init-link').onclick = async () => {
            await speak("Sistemas prontos para manifestação.");
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                document.querySelector('#interface').style.opacity = '0';
                setTimeout(() => document.querySelector('#interface').remove(), 1000);
                status.innerText = "VOID READY - AGUARDANDO COMANDO";
            } catch(e) { status.innerText = "ERRO DE MICROFONE"; }
        };

        core.addEventListener('click', () => {
            core.setAttribute('material', 'color', '#FF00FF', true); // Mudança via componente
            status.innerText = "ESCUTANDO...";
            recognition.start();
        });

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            status.innerText = `PROCESSANDO: "${transcript.toUpperCase()}"`;
            core.setAttribute('material', 'color', '#FFFF00');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Aja como o sistema VOID. Ensine sobre "${transcript}" em 3 etapas. Responda APENAS um JSON array: [{"l": "Letra ou Simbolo", "s": "box|sphere|torus|cone", "c": "#hex", "t": "Explicação"}].` }] }]
                    })
                });

                const data = await response.json();
                const raw = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(raw.match(/\[.*\]/s)[0]);

                for(let etapa of json) {
                    // Atualiza Visual
                    textEl.setAttribute('value', etapa.l);
                    textEl.setAttribute('color', etapa.c);
                    shapeEl.setAttribute('geometry', `primitive: ${etapa.s}; radius: 0.2; height: 0.4`);
                    shapeEl.setAttribute('material', `color: ${etapa.c}; shader: flat; emissive: ${etapa.c}; emissiveIntensity: 2`);
                    
                    // Animação de entrada
                    shapeEl.emit('show');
                    
                    // Fala
                    await speak(etapa.t);
                    await new Promise(r => setTimeout(r, 1500));
                    
                    // Animação de saída
                    shapeEl.emit('hide');
                    await new Promise(r => setTimeout(r, 600));
                }
                
                status.innerText = "FLUXO CONCLUÍDO";
                core.setAttribute('material', 'color', '#00FFFF');
                textEl.setAttribute('value', '');
            } catch(e) {
                status.innerText = "CONEXÃO NEURAL OSCILOU";
                await speak("O Vazio oscilou. Reequilibrando.");
                core.setAttribute('material', 'color', '#00FFFF');
            }
        };

        recognition.onend = () => {
            if(core.getAttribute('material').color === '#FF00FF') core.setAttribute('material', 'color', '#00FFFF');
        };
    </script>
</body>
</html>
