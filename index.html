<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VOID - Etapa XXII (Voz Melhorada)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        #audio-unlock {
            position: fixed; top: 10px; left: 10px; z-index: 9999;
            padding: 15px; background: #00FFFF; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-family: sans-serif;
        }
    </style>
</head>
<body>
    <button id="audio-unlock">ATIVAR ÁUDIO DA AULA</button>

    <a-scene background="color: #000000">
        <a-entity id="void-core" 
                  geometry="primitive: sphere; radius: 0.15" 
                  material="color: #00FFFF; shader: flat" 
                  position="0 1.5 -2">
        </a-entity>
        <a-camera position="0 1.6 0"><a-cursor color="#00FFFF"></a-cursor></a-camera>
    </a-scene>

    <script>
        // --- CONFIGURAÇÃO DA CHAVE E API ---
        let API_KEY = localStorage.getItem('gemini_key');
        if (!API_KEY) {
            API_KEY = prompt("Cole sua API Key:");
            if (API_KEY) localStorage.setItem('gemini_key', API_KEY.trim());
        }

        const core = document.querySelector('#void-core');
        const unlockBtn = document.querySelector('#audio-unlock');

        // --- SISTEMA DE VOZ APERFEIÇOADO ---
        let voices = [];
        const loadVoices = () => {
            voices = window.speechSynthesis.getVoices();
        };
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        const speakNatural = (text) => {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Busca por vozes de alta qualidade (Google ou Premium)
            const bestVoice = voices.find(v => 
                (v.name.includes('Google') || v.name.includes('Neural') || v.name.includes('Premium')) && 
                v.lang.includes('pt')
            ) || voices.find(v => v.lang.includes('pt'));

            if (bestVoice) utterance.voice = bestVoice;
            
            utterance.lang = 'pt-BR';
            utterance.rate = 0.95; // Levemente mais lento para clareza educacional
            utterance.pitch = 1.0; // Tom neutro e agradável
            utterance.volume = 1.0;
            
            window.speechSynthesis.speak(utterance);
        };

        unlockBtn.addEventListener('click', () => {
            speakNatural("Sistema de áudio pronto para a aula.");
            unlockBtn.style.display = 'none';
        });

        // --- RECONHECIMENTO E IA ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR';

        document.body.onmousedown = () => {
            try {
                recognition.start();
                core.setAttribute('material', 'color', '#FF00FF'); 
            } catch (e) {}
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            core.setAttribute('material', 'color', '#FFFF00'); 

            try {
                // Modelo confirmado via print do AI Studio
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Explique de forma didática e curta: "${transcript}". No fim, cite uma cor HEX.` }] }]
                    })
                });

                const data = await response.json();
                if (data.candidates) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    const hexMatch = aiText.match(/#[0-9A-F]{6}/i);
                    const hexColor = hexMatch ? hexMatch[0] : '#00FFFF';

                    core.setAttribute('material', 'color', hexColor);
                    
                    // Remove o código HEX do áudio para não soar robótico
                    const cleanText = aiText.replace(/#[0-9A-F]{6}/gi, '').trim();
                    speakNatural(cleanText);
                }
            } catch (err) {
                core.setAttribute('material', 'color', '#FF0000');
                console.error("Erro na requisição:", err);
            }
        };
    </script>
</body>
</html>
