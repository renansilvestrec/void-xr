<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>VOID - Etapa 4</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>
<body>
    <a-scene background="color: #000000">
        <a-entity id="void-core" 
                  geometry="primitive: sphere; radius: 0.1" 
                  material="color: #00FFFF; shader: flat" 
                  position="0 1.5 -2"
                  animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 1000; loop: true">
        </a-entity>

        <a-camera position="0 1.6 0">
            <a-cursor color="#00FFFF" radius-inner="0.002" radius-outer="0.003"></a-cursor>
        </a-camera>

        <a-entity oculus-touch-controls="hand: right"></a-entity>
    </a-scene>

    <script>
        // CONFIGURAÇÃO - Substitua pela sua nova chave gerada no AI Studio
        const API_KEY = 'AIzaSyBY-OoB6hm3UsrpqbI43CSqHlUtRliuoM4'; 
        
        const core = document.querySelector('#void-core');
        
        // Configuração de Reconhecimento de Voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Seu navegador não suporta reconhecimento de voz. Tente no Chrome ou Quest Browser.");
        }
        
        const recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.interimResults = false;

        // Iniciar ao clicar/gatilho
        document.body.onmousedown = () => {
            try {
                recognition.start();
                core.setAttribute('material', 'color', '#FF00FF'); // Magenta = Ouvindo
                console.log("Ouvindo...");
            } catch (e) {
                console.log("Reconhecimento já está ativo.");
            }
        };

        // Processar Resultado
        recognition.onresult = async (event) => {
            const userText = event.results[0][0].transcript;
            console.log("Usuário disse:", userText);
            core.setAttribute('material', 'color', '#FFFF00'); // Amarelo = Pensando

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ 
                                text: `Você é o sistema VOID. Responda de forma curta (max 20 palavras) sobre: "${userText}". No final da frase, escreva apenas o código HEX de uma cor que represente o assunto.` 
                            }] 
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error.message || "Erro na API");
                }

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                console.log("Resposta Gemini:", aiResponse);

                // Extrair Cor HEX e Limpar Texto
                const hexMatch = aiResponse.match(/#[0-9A-F]{6}/i);
                const hexColor = hexMatch ? hexMatch[0] : '#00FF00';
                const textToSpeak = aiResponse.replace(hexColor, '').trim();

                // Feedback Visual
                core.setAttribute('material', 'color', hexColor);

                // Síntese de Voz Robusta
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.0;
                
                // Forçar voz em PT-BR se disponível
                const voices = window.speechSynthesis.getVoices();
                const brVoice = voices.find(v => v.lang.includes('pt-BR'));
                if (brVoice) utterance.voice = brVoice;

                window.speechSynthesis.speak(utterance);

            } catch (error) {
                console.error("Erro:", error);
                core.setAttribute('material', 'color', '#FF0000'); // Vermelho = Erro
                alert("Erro: " + error.message);
            }
        };

        recognition.onerror = (event) => {
            console.error("Erro reconhecimento:", event.error);
            core.setAttribute('material', 'color', '#00FFFF');
        };
    </script>
</body>
</html>
